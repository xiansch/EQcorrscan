

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.3. match_filter &mdash; EQcorrscan 0.1.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/EQcorrscan_logo.ico"/>
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="EQcorrscan 0.1.0 documentation" href="../index.html"/>
        <link rel="up" title="3. Core" href="../core.html"/>
        <link rel="next" title="3.4. lag_calc" href="core.lag_calc.html"/>
        <link rel="prev" title="3.2. template_gen" href="core.template_gen.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> EQcorrscan</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">1. Introduction to the EQcorrscan package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro.html#why-eqcorrscan">1.1. Why EQcorrscan?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro.html#installation">1.2. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro.html#functions">1.3. Functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">2. EQcorrscan tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/template-creation.html">2.1. Template creation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/matched-filter.html">2.2. Matched-filter detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/lag-calc.html">2.3. Lag time calculation and pick correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/mag-calc.html">2.4. Magnitude calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/clustering.html">2.5. Clustering and stacking</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../core.html">3. Core</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="core.bright_lights.html">3.1. bright_lights</a></li>
<li class="toctree-l2"><a class="reference internal" href="core.template_gen.html">3.2. template_gen</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">3.3. match_filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="core.lag_calc.html">3.4. lag_calc</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../utils.html">4. Utils</a><ul>
<li class="toctree-l2"><a class="reference internal" href="utils.Sfile_util.html">4.1. Sfile_util</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.findpeaks.html">4.2. findpeaks</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.clustering.html">4.3. clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.pre_processing.html">4.4. pre_processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.EQcorrscan_plotting.html">4.5. EQcorrscan_plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.mag_calc.html">4.6. mag_calc</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.stacking.html">4.7. stacking</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.catalogue2DD.html">4.8. catalogue2DD</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">EQcorrscan</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../core.html">3. Core</a> &raquo;</li>
      
    <li>3.3. match_filter</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/submodules/core.match_filter.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="module-match_filter">
<span id="match-filter"></span><h1>3.3. match_filter<a class="headerlink" href="#module-match_filter" title="Permalink to this headline">¶</a></h1>
<p>Function to cross-correlate templates generated by template_gen functionwith data and output the detecitons.  The main component of this script is thenormxcorr2 function from the openCV image processing package.  This is ahighly optimized and accurate normalized cross-correlation routine.  Thedetails of this code can be found here:* <a class="reference external" href="http://www.cs.ubc.ca/research/deaton/remarks_ncc.html">http://www.cs.ubc.ca/research/deaton/remarks_ncc.html</a>The cpp code was first tested using the Matlab mex wrapper, and has since beenported to a python callable dynamic library.</p>
<p>Part of the EQcorrscan module to integrate seisan nordic files into a fullcross-channel correlation for detection routine.EQcorrscan is a python module designed to run match filter routines forseismology, within it are routines for integration to seisan and obspy.With obspy integration (which is necessary) all main waveform formats can beread in and output.</p>
<p>This main section contains a script, LFE_search.py which demonstrates theusage of the built in functions from template generation from picked waveformsthrough detection by match filter of continuous data to the generation of lagtimes to be used for relative locations.</p>
<p>The match-filter routine described here was used a previous Matlab code forthe Chamberlain et al. 2014 G-cubed publication.  The basis for the lag-timegeneration section is outlined in Hardebeck &amp; Shelly 2011, GRL.</p>
<p>Code generated by Calum John Chamberlain of Victoria University of Wellington,2015.</p>
<p class="rubric">Note</p>
<dl class="docutils">
<dt>Pre-requisites:</dt>
<dd><ul class="first last">
<li><p class="first">gcc             - for the installation of the openCV correlation routine</p>
</li>
<li><p class="first">python-cv2      - Python bindings for the openCV routines</p>
</li>
<li><p class="first">python-joblib   - used for parallel processing</p>
</li>
<li><dl class="first docutils">
<dt>python-obspy    - used for lots of common seismological processing</dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt>requires:</dt>
<dd><ul class="first last simple">
<li>numpy</li>
<li>scipy</li>
<li>matplotlib</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">NonLinLoc       - used outside of all codes for travel-time generation</p>
</li>
</ul>
</dd>
</dl>
<p>Copyright 2015 Calum Chamberlain</p>
<p>This file is part of EQcorrscan.</p>
<blockquote>
<div><p>EQcorrscan is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.</p>
<p>EQcorrscan is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License
along with EQcorrscan.  If not, see &lt;<a class="reference external" href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>&gt;.</p>
</div></blockquote>
<dl class="class">
<dt id="match_filter.DETECTION">
<em class="property">class </em><code class="descclassname">match_filter.</code><code class="descname">DETECTION</code><span class="sig-paren">(</span><em>template_name</em>, <em>detect_time</em>, <em>no_chans</em>, <em>detect_val</em>, <em>threshold</em>, <em>typeofdet</em>, <em>chans=None</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/match_filter.html#DETECTION"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#match_filter.DETECTION" title="Permalink to this definition">¶</a></dt>
<dd><p>Information required for a full detection based on cross-channelcorrelation sums.</p>
<dl class="docutils">
<dt>Attributes:</dt>
<dd><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">type template_name:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">str</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">param template_name:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body">The name of the template for which this</td>
</tr>
</tbody>
</table>
<p class="last">detection was made.
:type detect_time: :class: &#8216;obspy.UTCDateTime&#8217;
:param detect_time: Time of detection as an obspy UTCDateTime object
:type no_chans: int
:param no_chans: The number of channels for which the cross-channelcorrelation sum was calculated over.
:type chans: list of str
:param chans: List of stations for the detection
:type cccsum_val: float
:param cccsum_val: The raw value of the cross-channel correlation sumfor this detection.
:type threshold: float
:param threshold: The value of the threshold used for this detection,will be the raw threshold value related to the cccsum.
:type typeofdet: str
:param typeofdet: Type of detection, STA, corr, bright</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="match_filter._channel_loop">
<code class="descclassname">match_filter.</code><code class="descname">_channel_loop</code><span class="sig-paren">(</span><em>templates</em>, <em>stream</em>, <em>cores=1</em>, <em>debug=0</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/match_filter.html#_channel_loop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#match_filter._channel_loop" title="Permalink to this definition">¶</a></dt>
<dd><p>Loop to generate cross channel correaltion sums for a series of templateshands off the actual correlations to a sister function which can be run inparallel.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>templates</strong> &#8211; A list of templates, where each one should be an</td>
</tr>
</tbody>
</table>
<p>obspy.Stream object containing multiple traces of seismic data and therelevant header information.
:param stream: A single obspy.Stream object containing daylong seismicdata to be correlated through using the templates.  This is in effect theimage.
:type core: int
:param core: Number of cores to loop over
:type debug: int
:param debug: Debug level.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">New list of :class: &#8216;numpy.array&#8217; objects.  These will contain</td>
</tr>
</tbody>
</table>
<p>the correlation sums for each template for this day of data.
:return: list of ints as number of channels used for each cross-correlation</p>
</dd></dl>

<dl class="function">
<dt id="match_filter._template_loop">
<code class="descclassname">match_filter.</code><code class="descname">_template_loop</code><span class="sig-paren">(</span><em>template</em>, <em>chan</em>, <em>station</em>, <em>channel</em>, <em>debug=0</em>, <em>i=0</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/match_filter.html#_template_loop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#match_filter._template_loop" title="Permalink to this definition">¶</a></dt>
<dd><p>Sister loop to handle the correlation of a single template (of multiple
channels) with a single channel of data.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>i</strong> (<a class="reference external" href="https://docs.python.org/library/functions.html#int" title="(in Python v2.7)"><em>int</em></a>) &#8211; Optional argument, used to keep track of which process is being</td>
</tr>
</tbody>
</table>
<p>run.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">tuple of (i, ccc) with ccc as an ndarray</td>
</tr>
</tbody>
</table>
<p class="rubric">Note</p>
<dl class="docutils">
<dt>..This function currently assumes only one template-channel per</dt>
<dd>data-channel, while this is normal for a standard matched-filter routine,
if we wanted to impliment a subspace detector, this would be the function
to change, I think.  E.g. where I currently take only the first matching
channel, we could loop through all the matching channels and then sum the
correlation sums - however I don&#8217;t really understand how you detect based
on that.  More reading of the Harris document required.</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="match_filter.match_filter">
<code class="descclassname">match_filter.</code><code class="descname">match_filter</code><span class="sig-paren">(</span><em>template_names</em>, <em>template_list</em>, <em>st</em>, <em>threshold</em>, <em>threshold_type</em>, <em>trig_int</em>, <em>plotvar</em>, <em>plotdir='.'</em>, <em>cores=1</em>, <em>tempdir=False</em>, <em>debug=0</em>, <em>plot_format='jpg'</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/match_filter.html#match_filter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#match_filter.match_filter" title="Permalink to this definition">¶</a></dt>
<dd><p>Over-arching code to run the correlations of given templates with aday of seismic data and output the detections based on a given threshold.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>template_names</strong> (<a class="reference external" href="https://docs.python.org/library/functions.html#list" title="(in Python v2.7)"><em>list</em></a>) &#8211; List of template names in the same order astemplate_list</li>
<li><strong>template_list</strong> (<em>list :class: &#8216;obspy.Stream&#8217;</em>) &#8211; A list of templates of which each template is aStream of obspy traces containing seismic data and header information.</li>
<li><strong>st</strong> &#8211; An obspy.Stream object containing all the data available andrequired for the correlations with templates given.  For efficiencythis should contain no excess traces which are not in one or more ofthe templates.  This will now remove excess traces internally, butwill copy the stream and work on the copy, leaving your input streamuntouched.</li>
<li><strong>threshold</strong> (<a class="reference external" href="https://docs.python.org/library/functions.html#float" title="(in Python v2.7)"><em>float</em></a>) &#8211; A threshold value set based on the threshold_type</li>
<li><strong>threshold_type</strong> (<a class="reference external" href="https://docs.python.org/library/functions.html#str" title="(in Python v2.7)"><em>str</em></a>) &#8211; The type of threshold to be used, can be MAD,absolute or av_chan_corr.    MAD threshold is calculated as thethreshold*(median(abs(cccsum))) where cccsum is the cross-correlationsum for a given template. absolute threhsold is a true absolutethreshold based on the cccsum value av_chan_corr is based on the meanvalues of single-channel cross-correlations assuming all data arepresent as required for the template, e.g. av_chan_corr_thresh=threshold*(cccsum/len(template)) wheretemplate is a single template from the input and the length is thenumber of channels within this template.</li>
<li><strong>trig_int</strong> (<a class="reference external" href="https://docs.python.org/library/functions.html#float" title="(in Python v2.7)"><em>float</em></a>) &#8211; Minimum gap between detections in seconds.</li>
<li><strong>plotvar</strong> (<a class="reference external" href="https://docs.python.org/library/functions.html#bool" title="(in Python v2.7)"><em>bool</em></a>) &#8211; Turn plotting on or off</li>
<li><strong>plotdir</strong> (<a class="reference external" href="https://docs.python.org/library/functions.html#str" title="(in Python v2.7)"><em>str</em></a>) &#8211; Path to plotting folder, plots will be output here,defaults to run location.</li>
<li><strong>tempdir</strong> (<em>String or False</em>) &#8211; Directory to put temporary files, or False</li>
<li><strong>cores</strong> (<a class="reference external" href="https://docs.python.org/library/functions.html#int" title="(in Python v2.7)"><em>int</em></a>) &#8211; Number of cores to use</li>
<li><strong>debug</strong> (<a class="reference external" href="https://docs.python.org/library/functions.html#int" title="(in Python v2.7)"><em>int</em></a>) &#8211; Debug output level, the bigger the number, the more theoutput.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">class:</th><td class="field-body">&#8216;DETECTIONS&#8217; detections for each channel formatted as</td>
</tr>
</tbody>
</table>
</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Class:</th><td class="field-body"><p class="first last">&#8216;obspy.UTCDateTime&#8217; objects.</p>
</td>
</tr>
</tbody>
</table>
<p class="rubric">Note
Plotting within the match-filter routine uses the Agg backend withinteractive plotting turned off.  This is because the function isdesigned to work in bulk.  If you wish to turn interactive plotting onyou must import matplotlib in your script first, when you them importmatch_filter you will get the warning that this call to matplotlib hasno effect, which will mean that match_filter has not changed theplotting behaviour.</p>
</dd></dl>

<dl class="function">
<dt id="match_filter.normxcorr2">
<code class="descclassname">match_filter.</code><code class="descname">normxcorr2</code><span class="sig-paren">(</span><em>template</em>, <em>image</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/match_filter.html#normxcorr2"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#match_filter.normxcorr2" title="Permalink to this definition">¶</a></dt>
<dd><p>Base function to call the c++ correlation routine from the openCV imageprocessing suite.  Requires you to have installed the openCV pythonbindings, which can be downloaded on Linux machines using:<strong>sudo apt-get install python-openCV</strong>.</p>
<p>Here we use the cv2.TM_CCOEFF_NORMED method within openCV to give thenormalized cross-correaltion.  Documentation on this function can befound here:</p>
<p><strong>http://docs.opencv.org/modules/imgproc/doc/object_detection.html?highlight=matchtemplate#cv2.matchTemplate</strong></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>template</strong> &#8211; Template array</li>
<li><strong>image</strong> &#8211; image to scan</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>the template through.  The order of these matters, if you put the templateafter the image you will get a reversed correaltion matrix</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">New :class: &#8216;numpy.array&#8217; object of the correlation values for</td>
</tr>
</tbody>
</table>
<p>the correlation of the image with the template.</p>
</dd></dl>

</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="core.lag_calc.html" class="btn btn-neutral float-right" title="3.4. lag_calc">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="core.template_gen.html" class="btn btn-neutral" title="3.2. template_gen"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, 2016: Calum John Chamberlain &amp; Chet Hopp.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>