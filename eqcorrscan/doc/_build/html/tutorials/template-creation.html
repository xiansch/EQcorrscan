

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2.1. Template creation &mdash; EQcorrscan 0.1.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/EQcorrscan_logo.ico"/>
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="EQcorrscan 0.1.0 documentation" href="../index.html"/>
        <link rel="up" title="2. EQcorrscan tutorial" href="../tutorial.html"/>
        <link rel="next" title="2.2. Matched-filter detection" href="matched-filter.html"/>
        <link rel="prev" title="2. EQcorrscan tutorial" href="../tutorial.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> EQcorrscan</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">1. Introduction to the EQcorrscan package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro.html#why-eqcorrscan">1.1. Why EQcorrscan?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro.html#installation">1.2. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro.html#functions">1.3. Functions</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">2. EQcorrscan tutorial</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="">2.1. Template creation</a></li>
<li class="toctree-l2"><a class="reference internal" href="matched-filter.html">2.2. Matched-filter detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="lag-calc.html">2.3. Lag time calculation and pick correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="mag-calc.html">2.4. Magnitude calculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="clustering.html">2.5. Clustering and stacking</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../core.html">3. Core</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../submodules/core.bright_lights.html">3.1. bright_lights</a></li>
<li class="toctree-l2"><a class="reference internal" href="../submodules/core.template_gen.html">3.2. template_gen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../submodules/core.match_filter.html">3.3. match_filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../submodules/core.lag_calc.html">3.4. lag_calc</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../utils.html">4. Utils</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../submodules/utils.Sfile_util.html">4.1. Sfile_util</a></li>
<li class="toctree-l2"><a class="reference internal" href="../submodules/utils.findpeaks.html">4.2. findpeaks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../submodules/utils.clustering.html">4.3. clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../submodules/utils.pre_processing.html">4.4. pre_processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../submodules/utils.EQcorrscan_plotting.html">4.5. EQcorrscan_plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../submodules/utils.mag_calc.html">4.6. mag_calc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../submodules/utils.stacking.html">4.7. stacking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../submodules/utils.catalogue2DD.html">4.8. catalogue2DD</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">EQcorrscan</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../tutorial.html">2. EQcorrscan tutorial</a> &raquo;</li>
      
    <li>2.1. Template creation</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/tutorials/template-creation.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="template-creation">
<h1>2.1. Template creation<a class="headerlink" href="#template-creation" title="Permalink to this headline">Â¶</a></h1>
<p>In this example we will download some data and picks from the New Zealand GeoNet
database and make use of the functions in EQcorrscan to quickly and simply
generate templates for use in matched-filter detection.  In the example we
are looking at an earthquake sequence on the east coast of New Zealand&#8217;s North
Island that occurred on the 4th of January 2016.  We will take a set of four
template events from the sequence that have been picked by GeoNet, of a range
of magnitudes.  You can decide if these were <em>good</em> templates or not.  You could
easily extend this by choosing more template events (the mainshock in the
sequence is a M 5 and you can get the information by clicking
<a class="reference external" href="http://www.geonet.org.nz/quakes/region/newzealand/2016p008122">here</a>).</p>
<p>You do not need to use data from an online server, many pick formats can be
parsed, either by obspy, or (for seisan pick files) through the Sfile_utils
module in EQcorrscan.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Simple tutorial detailing how to generate a series of templates from catalog\</span>
<span class="sd">data available online.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">eqcorrscan.core</span> <span class="kn">import</span> <span class="n">template_gen</span>
<span class="kn">from</span> <span class="nn">eqcorrscan.utils</span> <span class="kn">import</span> <span class="n">pre_processing</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="c"># This import section copes with namespace changes between obspy versions</span>
<span class="kn">import</span> <span class="nn">obspy</span>
<span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">obspy.clients.fdsn</span> <span class="kn">import</span> <span class="n">Client</span>
    <span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">read_events</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">obspy.fdsn</span> <span class="kn">import</span> <span class="n">Client</span>
    <span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">readEvents</span> <span class="k">as</span> <span class="n">read_events</span>
<span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">UTCDateTime</span><span class="p">,</span> <span class="n">Stream</span>
<span class="kn">from</span> <span class="nn">obspy.core.event</span> <span class="kn">import</span> <span class="n">Catalog</span>

<span class="c"># We want to download some QuakeML files from the New Zealand GeoNet network,</span>
<span class="c"># Obspy doesn&#39;t format the request in the way that GeoNet have written it, so</span>
<span class="c"># we have to work around a bit.</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s">&quot;GEONET&quot;</span><span class="p">)</span>
<span class="c"># We want to download a few events from an earthquake sequence, these are</span>
<span class="c"># identified by publiID numbers</span>
<span class="n">publicIDs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;2016p008122&#39;</span><span class="p">,</span> <span class="s">&#39;2016p008353&#39;</span><span class="p">,</span> <span class="s">&#39;2016p008155&#39;</span><span class="p">,</span> <span class="s">&#39;2016p008194&#39;</span><span class="p">]</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">()</span>
<span class="k">for</span> <span class="n">publicID</span> <span class="ow">in</span> <span class="n">publicIDs</span><span class="p">:</span>
    <span class="n">data_stream</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">_download</span><span class="p">(</span><span class="s">&#39;http://quakeml.geonet.org.nz/quakeml/&#39;</span> <span class="o">+</span>
                                   <span class="s">&#39;1.2/&#39;</span> <span class="o">+</span> <span class="n">publicID</span><span class="p">)</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">catalog</span> <span class="o">+=</span> <span class="n">read_events</span><span class="p">(</span><span class="n">data_stream</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;quakeml&quot;</span><span class="p">)</span>
    <span class="n">data_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c"># Now we should have a catalog of a four events with pick and event information</span>
<span class="c"># We need the seismic data to go with this.  We are going to focus on one day</span>
<span class="c"># of data for this tutorial, all events are from the 4th of January.  We will</span>
<span class="c"># download that day of data for five sites nearby the earthquakes.</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="s">&quot;2016-01-04T00:00:00.000&quot;</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="mi">86400</span>

<span class="c"># Work out what stations we have picks for all events from</span>

<span class="n">all_picks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">catalog</span><span class="p">:</span>
    <span class="n">all_picks</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">pick</span><span class="o">.</span><span class="n">waveform_id</span><span class="o">.</span><span class="n">station_code</span><span class="p">,</span>
                   <span class="n">pick</span><span class="o">.</span><span class="n">waveform_id</span><span class="o">.</span><span class="n">channel_code</span><span class="p">)</span> <span class="k">for</span> <span class="n">pick</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">picks</span><span class="p">]</span>
<span class="n">all_picks</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">all_picks</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">all_picks</span> <span class="o">=</span> <span class="p">[</span><span class="n">pick</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pick</span> <span class="ow">in</span> <span class="n">all_picks</span><span class="p">]</span>

<span class="n">bulk_info</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">all_picks</span><span class="p">:</span>
    <span class="n">bulk_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;NZ&#39;</span><span class="p">,</span> <span class="n">station</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="n">station</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">))</span>

<span class="c"># Note this will take a little while.</span>
<span class="k">print</span><span class="p">(</span><span class="s">&#39;Downloading seismic data, this may take a while&#39;</span><span class="p">)</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_waveforms_bulk</span><span class="p">(</span><span class="n">bulk_info</span><span class="p">)</span>
<span class="c"># Merge the stream, it will be downloaded in chunks</span>
<span class="n">st</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="s">&#39;interpolate&#39;</span><span class="p">)</span>
<span class="c"># Work out what data we actually have to cope with possible lost data</span>
<span class="n">stations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">]))</span>

<span class="c"># Pre-process the data to set frequency band and sampling rate</span>
<span class="k">print</span><span class="p">(</span><span class="s">&#39;Processing the seismic data&#39;</span><span class="p">)</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">10</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">pre_processing</span><span class="o">.</span><span class="n">dayproc</span><span class="p">)</span>
                         <span class="p">(</span><span class="n">tr</span><span class="o">=</span><span class="n">tr</span><span class="p">,</span> <span class="n">lowcut</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">highcut</span><span class="o">=</span><span class="mf">9.0</span><span class="p">,</span> <span class="n">filt_order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                          <span class="n">samp_rate</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">starttime</span><span class="o">=</span><span class="n">t1</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">)</span>
<span class="c"># Convert from list to stream</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>

<span class="c"># Now we can generate the templates.  Note there are wrappers for generating</span>
<span class="c"># templates from QuakeML and seisan format pick files.</span>
<span class="n">templates</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">catalog</span><span class="p">:</span>
    <span class="n">picks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pick</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">picks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pick</span><span class="o">.</span><span class="n">waveform_id</span><span class="o">.</span><span class="n">station_code</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
            <span class="n">picks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pick</span><span class="p">)</span>
    <span class="c"># Now we can generate the template, for this tutorial we will plot the</span>
    <span class="c"># templates.</span>
    <span class="c"># Note, this makes more plots than I want, I think there is an issue with</span>
    <span class="c"># this loop</span>
    <span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template_gen</span><span class="o">.</span><span class="n">_template_gen</span><span class="p">(</span><span class="n">picks</span><span class="o">=</span><span class="n">picks</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                                                <span class="n">swin</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">prepick</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                                <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

<span class="c"># We now have a series of templates! Using obspys Stream.write() method we</span>
<span class="c"># can save these to disk for later use.  We will do that now for use in the</span>
<span class="c"># following tutorials.</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">templates</span><span class="p">):</span>
    <span class="n">template</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;tutorial_template_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.ms&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;MSEED&#39;</span><span class="p">)</span>
    <span class="c"># Note that this will warn you about data types.  As we don&#39;t care</span>
    <span class="c"># at the moment, whatever obspy chooses is fine.</span>
</pre></div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="matched-filter.html" class="btn btn-neutral float-right" title="2.2. Matched-filter detection">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../tutorial.html" class="btn btn-neutral" title="2. EQcorrscan tutorial"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, 2016: Calum John Chamberlain &amp; Chet Hopp.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>